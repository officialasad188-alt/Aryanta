<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aryanta AI</title>
    
    <script src="aryanta-config.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #101012; --primary-text-color: #f0f0f0; --secondary-text-color: #a0a0a0;
            --container-bg-color: rgba(22, 22, 25, 0.7); --sidebar-bg-color: rgba(16, 16, 18, 0.75);
            --accent-color-primary: #8ab4f8; --accent-color-secondary: #9B72CB;
            --user-message-bg: rgba(45, 46, 48, 0.9); --ai-message-bg: rgba(30, 32, 38, 0.9);
            --border-color: rgba(255, 255, 255, 0.1); --shadow-color: rgba(138, 180, 248, 0.15);
            --danger-color: #e57373;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body {
            font-family: 'Poppins', sans-serif; color: var(--primary-text-color); display: flex;
            justify-content: center; align-items: center; background: linear-gradient(135deg, #232526, #414345, #1c1e26, #2a2d39);
            background-size: 400% 400%; animation: gradient-animation 20s ease infinite;
        }
        
        /* NEW: Temporary Chat Border for Body */
        body.temp-chat-active-border {
            border: 3px dashed var(--danger-color);
            border-radius: 20px; /* Match the container */
            height: calc(100% - 6px); /* Account for border */
            width: calc(100% - 6px); /* Account for border */
        }

        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #start-screen { display: flex; flex-direction: column; align-items: center; text-align: center; animation: fadeInUp 0.8s ease-out; background: var(--container-bg-color); padding: 50px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        #logo { width: 120px; margin-bottom: 25px; animation: fadeInUp 0.8s ease-out 0.2s backwards; }
        #start-screen h1 { font-size: 5rem; font-weight: 600; background: linear-gradient(90deg, var(--accent-color-primary), var(--accent-color-secondary), #D96570); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 30px; }
        #startButton { background-image: linear-gradient(90deg, var(--accent-color-primary), var(--accent-color-secondary)); color: #fff; border: none; border-radius: 12px; padding: 14px 40px; font-size: 18px; font-weight: 500; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); }
        #startButton:hover { transform: translateY(-3px); box-shadow: 0 6px 25px var(--shadow-color); }
        #app-container { width: 100vw; height: 100vh; display: none; flex-direction: row; background-color: var(--container-bg-color); backdrop-filter: blur(20px); border: 1px solid var(--border-color); opacity: 0; transform: scale(0.98); transition: opacity 0.5s ease-in, transform 0.5s ease-in, border 0.3s ease; position: relative; }
        .visible { display: flex !important; } .active { opacity: 1 !important; transform: scale(1) !important; }
        #sidebar { width: 260px; background-color: var(--sidebar-bg-color); padding: 20px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease-in-out, opacity 0.3s ease, pointer-events 0.3s ease; }
        .sidebar-main { flex-grow: 1; display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        #newChatButton { width: 100%; background-color: transparent; border: 1px solid var(--border-color); color: var(--primary-text-color); padding: 12px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s ease; }
        #newChatButton:hover { background-color: rgba(255, 255, 255, 0.05); border-color: var(--accent-color-primary); }
        #chatHistory { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        #chatHistory::-webkit-scrollbar { width: 6px; } #chatHistory::-webkit-scrollbar-track { background: transparent; }
        #chatHistory::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; } #chatHistory::-webkit-scrollbar-thumb:hover { background: #555; }
        .history-item-container { display: flex; align-items: center; position: relative; }
        .history-item { flex-grow: 1; background: none; border: none; color: var(--secondary-text-color); padding: 12px; border-radius: 8px; text-align: left; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: all 0.2s ease; font-weight: 400; }
        .history-item:hover { background-color: var(--user-message-bg); color: var(--primary-text-color); }
        .history-item.active { background-color: var(--user-message-bg); color: var(--primary-text-color); font-weight: 500; }
        .history-menu-btn { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; padding: 8px; border-radius: 50%; line-height: 1; margin-left: 5px; transition: all 0.2s ease; }
        .history-menu-btn:hover { background-color: var(--user-message-bg); color: var(--primary-text-color); }
        .history-dropdown { display: none; position: absolute; right: 0; top: 40px; background-color: #2c2d32; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10; width: 120px; overflow: hidden; }
        .history-dropdown.show { display: block; }
        .dropdown-item { background: none; border: none; color: var(--primary-text-color); width: 100%; padding: 10px 15px; text-align: left; cursor: pointer; transition: all 0.2s ease; }
        .dropdown-item:hover { background-color: var(--accent-color-primary); color: var(--bg-color); }
        .sidebar-footer { padding-top: 15px; border-top: 1px solid var(--border-color); }
        .sidebar-button { width: 100%; background: none; border: none; color: var(--secondary-text-color); padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 15px; font-family: 'Poppins', sans-serif; transition: all 0.2s ease; text-decoration: none; }
        .sidebar-button:hover { background-color: var(--user-message-bg); color: var(--primary-text-color); }
        #chat-interface { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        #chat-header { position: absolute; top: 0; left: 0; width: 100%; display: flex; align-items: center; padding: 10px 15px; z-index: 100; }
        #menu-toggle-button { display: none; background: var(--user-message-bg); border: 1px solid var(--border-color); color: var(--primary-text-color); border-radius: 8px; padding: 8px; cursor: pointer; }
        
        /* Tools Button and Dropdown */
        #tools-button {
            background: var(--user-message-bg);
            border: 1px solid var(--border-color);
            color: var(--primary-text-color);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            margin-left: auto; /* Pushes it to the right */
            margin-right: 15px; /* Spacing */
            position: relative; /* For dropdown positioning */
        }
        #tools-button svg { width: 20px; height: 20px; }
        #tools-dropdown {
            display: none;
            position: absolute;
            top: 45px;
            right: 0;
            background-color: #2c2d32;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            width: 280px;
            padding: 15px;
        }
        #tools-dropdown.show { display: block; }
        #tools-dropdown .setting-option { /* Re-use setting-option style */
            background-color: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px; /* Space between toggles */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        #tools-dropdown .setting-option:last-child { margin-bottom: 0; }
        /* NEW: Temp Chat Button Style */
        #tools-dropdown .dropdown-item {
            font-size: 14px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: rgba(255,255,255,0.05);
            border: 1px solid transparent; /* Placeholder for dashed border */
        }
        #tools-dropdown .dropdown-item:last-child { margin-bottom: 0; }
        #tools-dropdown .dropdown-item:hover {
            background-color: var(--accent-color-primary);
            color: var(--bg-color);
        }
        /* NEW: Active Temp Chat Button Style */
        #tools-dropdown .dropdown-item.temp-chat-active {
            border: 1px dashed var(--danger-color);
            color: var(--danger-color);
        }
        #tools-dropdown .dropdown-item.temp-chat-active:hover {
            background-color: rgba(229, 115, 115, 0.1);
            color: var(--danger-color);
        }


        #chat-logo-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; opacity: 0.069; pointer-events: none; transition: opacity 0.5s ease; }
        .chat-window { flex-grow: 1; padding: 70px 30px 20px 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .chat-window::-webkit-scrollbar { width: 8px; } .chat-window::-webkit-scrollbar-track { background: transparent; }
        .chat-window::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; } .chat-window::-webkit-scrollbar-thumb:hover { background: #444; }
        .message-pair { display: flex; flex-direction: column; gap: 15px; }
        .user-message, .ai-message { position: relative; display: flex; align-items: flex-start; padding: 14px 20px; border-radius: 20px; max-width: 80%; word-wrap: break-word; animation: fadeInUp 0.4s ease-out; white-space: pre-wrap; line-height: 1.6; }
        .user-message { background-color: var(--user-message-bg); border-bottom-right-radius: 6px; align-self: flex-end; color: #d0d0d0; }
        .ai-message { background-color: var(--ai-message-bg); border-bottom-left-radius: 6px; align-self: flex-start; }
        .message-content { flex-grow: 1; }
        .ai-message pre { font-family: 'SF Mono', 'Consolas', monospace; font-size: 0.9em; padding: 15px; margin-top: 10px; background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; white-space: pre-wrap; line-height: 1.5; color: #c5c5c5; }
        .ai-message img, .user-message img { max-width: 100%; border-radius: 12px; margin-top: 10px; cursor: pointer; transition: opacity 0.2s ease; }
        .ai-message img:hover, .user-message img:hover { opacity: 0.8; }
        .user-message b, .ai-message b { display: block; margin-bottom: 5px; font-weight: 600; }
        .user-message b { color: var(--accent-color-primary); } .ai-message b { color: var(--accent-color-secondary); }
        .speak-btn { background: none; border: none; cursor: pointer; padding: 0; margin-left: 12px; opacity: 0.6; transition: opacity 0.2s ease; }
        .speak-btn:hover { opacity: 1; } .speak-btn svg { width: 18px; height: 18px; fill: var(--secondary-text-color); }
        .speak-btn.speaking svg { animation: pulse 1.2s infinite ease-in-out; fill: var(--accent-color-primary); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .input-area-container { display: flex; flex-direction: column; }
        .input-area { display: flex; align-items: center; padding: 15px 30px; border-top: 1px solid var(--border-color); background-color: var(--sidebar-bg-color); flex-shrink: 0; }
        .input-wrapper { flex-grow: 1; position: relative; display: flex; flex-direction: column; background-color: #2a2b2c; border-radius: 12px; transition: box-shadow 0.2s ease; }
        .input-wrapper:focus-within { box-shadow: 0 0 0 2px var(--accent-color-primary); }
        .input-controls { display: flex; align-items: center; width: 100%; padding: 0 10px; }
        textarea#userInput { flex-grow: 1; background-color: transparent; border: none; padding: 15px 10px; color: var(--primary-text-color); font-family: 'Poppins', sans-serif; font-size: 16px; resize: none; height: 52px; outline: none; max-height: 150px; overflow-y: auto; width: 100%; }
        .input-button { background: none; border: none; cursor: pointer; padding: 10px; margin: 0 2px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .input-button svg { width: 24px; height: 24px; fill: var(--secondary-text-color); transition: fill 0.2s ease; }
        .input-button:hover:not(:disabled) svg { fill: var(--accent-color-primary); }
        #sendButton { background: var(--accent-color-primary); border-radius: 8px; margin-left: 10px; }
        #sendButton svg { fill: var(--bg-color); } #sendButton:hover:not(:disabled) { background: #79a6f7; }
        
        /* NEW: Stop Button Animation */
        #stopButton {
            animation: pulse-stop 0.8s infinite alternate ease-in-out;
        }
        #stopButton svg { fill: var(--danger-color); }
        #stopButton:hover svg { fill: #f55; transform: scale(1.1); }
        @keyframes pulse-stop {
        from { transform: scale(0.95); opacity: 0.8; }
        to { transform: scale(1.05); opacity: 1; }
        }
        
        #predefined-questions { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; padding: 0 30px; animation: fadeInUp 0.6s ease-out 0.3s backwards; display: none; }
        .predefined-q { background-color: rgba(255, 255, 255, 0.05); color: var(--primary-text-color); border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 18px; font-size: 14px; font-weight: 400; cursor: pointer; transition: all 0.2s ease; }
        .predefined-q:hover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--accent-color-primary); transform: translateY(-2px); }
        .typing-cursor::after { content: '▋'; animation: blink 1s step-end infinite; color: var(--accent-color-secondary); margin-left: 2px; }
        @keyframes blink { 50% { opacity: 0; } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--sidebar-bg-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 25px 30px; width: 90%; max-width: 500px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: fadeInUp 0.4s ease-out; }
        .modal-header { display: flex; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-weight: 500; flex-grow: 1; }
        .back-button { background: none; border: none; color: var(--primary-text-color); cursor: pointer; display: none; margin-right: 15px; }
        .back-button svg { width: 24px; height: 24px; }
        .setting-option, .language-option, .main-setting-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 8px; border: 1px solid transparent; transition: all 0.2s ease; margin-bottom: 15px; cursor: pointer; }
        .main-setting-item:hover { border-color: var(--border-color); }
        .language-option { justify-content: flex-start; gap: 12px; }
        .language-option:hover { border-color: var(--border-color); }
        .language-option input { accent-color: var(--accent-color-primary); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .modal-button { border: none; border-radius: 8px; padding: 10px 20px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-decoration: none; }
        #saveSettingsButton, #saveMemoriesButton { background-color: var(--accent-color-primary); color: var(--bg-color); }
        #saveSettingsButton:hover, #saveMemoriesButton:hover { opacity: 0.9; }
        #closeModalButton { background-color: var(--user-message-bg); color: var(--primary-text-color); }
        #closeModalButton:hover { background-color: #444; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color-primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        /* Premium Image Modal Styles */
        #image-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); 
            display: none; justify-content: center; align-items: center; 
            z-index: 2000; opacity: 0; transition: opacity 0.3s ease;
            flex-direction: column; /* Stack image and controls */
            gap: 20px;
        }
        #image-modal.show { display: flex; opacity: 1; }
        .fullscreen-image { 
            max-width: 90vw; max-height: 75vh; /* Make space for controls */
            object-fit: contain; border-radius: 8px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
        }
        .close-image-button { 
            position: absolute; top: 20px; right: 25px; 
            background: rgba(20,20,20,0.6); border: 1px solid rgba(255,255,255,0.1);
            color: white; width: 44px; height: 44px; 
            border-radius: 50%; font-size: 30px; line-height: 44px; 
            text-align: center; cursor: pointer; transition: all 0.3s ease; 
        }
        .close-image-button:hover { 
            background: rgba(0,0,0,0.8); transform: scale(1.1) rotate(90deg); 
        }
        .image-modal-controls {
            display: flex;
            gap: 15px;
            z-index: 2001;
        }
        /* Re-use modal-button style for image controls */
        .image-modal-controls .modal-button {
            background-color: var(--user-message-bg); 
            color: var(--primary-text-color);
        }
        .image-modal-controls .modal-button:hover { opacity: 0.9; }
        .image-modal-controls .modal-button.primary {
            background-color: var(--accent-color-primary);
            color: var(--bg-color);
        }
        #imageDownloadButton {
            background-color: var(--accent-color-primary);
            color: var(--bg-color);
        }
        
        .settings-view { display: none; } .settings-view.active { display: block; }
        .voice-option { display: flex; align-items: center; gap: 12px; background-color: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; margin-bottom: 10px; }
        .voice-option:hover { border-color: var(--border-color); }
        .voice-option.selected { border-color: var(--accent-color-primary); background-color: rgba(138, 180, 248, 0.1); }
        .voice-option svg { width: 20px; height: 20px; fill: var(--secondary-text-color); flex-shrink: 0; }
        .voice-option.selected svg { fill: var(--accent-color-primary); }
        .data-button, .modal-button.danger { background-color: var(--user-message-bg); color: var(--primary-text-color); border: 1px solid var(--border-color); width: 100%; padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; transition: background-color 0.2s ease; }
        .data-button:hover { background-color: #444; }
        .data-button.danger, .modal-button.danger { background-color: rgba(229, 115, 115, 0.2); border-color: var(--danger-color); color: var(--danger-color); }
        .data-button.danger:hover, .modal-button.danger:hover { background-color: rgba(229, 115, 115, 0.4); }
        
        /* NEW: Memory Settings Textarea */
        #memoryTextArea {
            width: 100%;
            height: 200px;
            background-color: #2a2b2c;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            color: var(--primary-text-color);
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            resize: vertical;
        }
        #memorySettings p {
            font-size: 14px;
            color: var(--secondary-text-color);
            margin-bottom: 15px;
        }

        /* Typing Speed Slider */
        .speed-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .speed-slider:hover { opacity: 1; }
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-color-primary);
            border-radius: 50%;
            cursor: pointer;
        }
        .speed-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-color-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .loading-indicator { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; padding: 20px; margin: 0 auto; color: var(--secondary-text-color); animation: fadeInUp 0.4s ease-out; }
        .loading-indicator .logo-container { position: relative; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; }
        .loading-indicator .spinner { position: absolute; width: 100%; height: 100%; border: 4px solid transparent; border-top-color: var(--accent-color-primary); border-radius: 50%; animation: rotate 1.5s linear infinite; }
        .loading-indicator img { width: 50px; height: 50px; }
        .loading-indicator p { font-size: 0.9em; }
        .ellipsis::after { display: inline-block; animation: ellipsis 1.5s infinite; content: "."; width: 1em; text-align: left; }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes ellipsis { 0% { content: "."; } 33% { content: ".."; } 66% { content: "..."; } }

        .message-actions { display: flex; gap: 8px; margin-top: 10px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .user-message:hover .message-actions, .ai-message:hover .message-actions { opacity: 1; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--secondary-text-color); }
        .action-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .action-btn:hover { color: var(--primary-text-color); }
        .action-btn.liked { color: var(--accent-color-primary); }
        .action-btn.disliked { color: var(--danger-color); }

        .disclaimer-text {
            font-size: 12px;
            color: var(--secondary-text-color);
            text-align: center;
            padding: 0 30px 10px 30px;
            transition: color 0.3s ease; /* Added for temp chat transition */
        }
        .disclaimer-text a {
            color: var(--accent-color-primary);
            text-decoration: none;
        }
        .disclaimer-text a:hover {
            text-decoration: underline;
        }
        .data-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .data-option-btn {
            background-color: var(--user-message-bg);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-grow: 1;
            font-size: 14px;
        }
        .data-option-btn:hover {
            background-color: #444;
        }
        .data-option-btn.selected {
            background-color: var(--accent-color-primary);
            color: var(--bg-color);
            border-color: var(--accent-color-primary);
            font-weight: 500;
        }

        #live-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(16, 16, 18, 0.95);
            backdrop-filter: blur(10px);
            z-index: 5000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        #live-logo {
            width: 150px;
            cursor: pointer;
            border-radius: 50%;
            animation: glow 3s infinite ease-in-out;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        #live-logo:hover {
            transform: scale(1.05);
        }
        #live-logo.listening {
            animation: glow-intense 1.5s infinite ease-in-out;
        }
        #live-status {
            margin-top: 30px;
            font-size: 1.2rem;
            color: var(--secondary-text-color);
            height: 30px; 
            transition: color 0.3s ease;
        }
        #closeLiveModeButton {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--primary-text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #closeLiveModeButton:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 15px rgba(138, 180, 248, 0.3), 0 0 20px rgba(155, 114, 203, 0.2); }
            50% { box-shadow: 0 0 30px rgba(138, 180, 248, 0.5), 0 0 40px rgba(155, 114, 203, 0.4); }
        }
        @keyframes glow-intense {
            0%, 100% { box-shadow: 0 0 30px rgba(138, 180, 248, 0.6), 0 0 45px rgba(155, 114, 203, 0.5); }
            50% { box-shadow: 0 0 50px rgba(138, 180, 248, 1), 0 0 70px rgba(155, 114, 203, 0.8); }
        }

        /* NEW: Share Modal */
        #shareModal .modal-content {
            max-width: 550px;
        }
        /* NEW: Share Modal Header */
        #shareModal .modal-header {
            position: relative; /* For the close button */
        }
        /* NEW: Share Modal 'X' Button Style */
        #shareModal .close-image-button {
            position: absolute; 
            top: -10px; 
            right: -5px; 
            background: rgba(20,20,20,0.6); 
            border: 1px solid rgba(255,255,255,0.1);
            color: white; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            font-size: 28px; 
            line-height: 36px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            z-index: 1001;
        }
        #shareModal .close-image-button:hover {
            background: rgba(0,0,0,0.8); 
            transform: scale(1.1) rotate(90deg); 
        }

        #share-content-preview {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .share-message {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            white-space: pre-wrap;
            max-width: 90%;
        }
        .share-message b {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .share-message-user {
            background-color: var(--user-message-bg);
            color: #d0d0d0;
            border-bottom-right-radius: 6px;
            margin-left: auto;
        }
        .share-message-user b {
            color: var(--accent-color-primary);
        }
        .share-message-ai {
            background-color: var(--ai-message-bg);
            color: var(--primary-text-color);
            border-bottom-left-radius: 6px;
            margin-top: 15px;
            margin-right: auto;
        }
        .share-message-ai b {
            color: var(--accent-color-secondary);
        }
        #shareModal .modal-buttons {
            /* MODIFIED: Center the only button */
            justify-content: center;
        }
        /* NEW: Hide Copy and Close buttons at bottom */
        #shareModal #shareModalCopy,
        #shareModal #shareModalClose {
            display: none;
        }
        #shareModalWhatsapp {
            background-color: #25D366;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #shareModalWhatsapp svg { width: 20px; height: 20px; fill: white; }
        #shareModalWhatsapp:hover { opacity: 0.9; }

        /* NEW: Toast Notification */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #2c2d32;
            border: 1px solid var(--border-color);
            color: var(--primary-text-color);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 14px;
            pointer-events: none;
        }
        #toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }


        @media (max-width: 768px) {
            #start-screen { width: 100%; height: 100%; border-radius: 0; justify-content: center; }
            #start-screen h1 { font-size: 3rem; }
            #app-container { height: 100%; border: none; border-radius: 0; }
            
            /* NEW: Temp Chat Border for Mobile */
            body.temp-chat-active-border {
                border: none;
                height: 100%;
                width: 100%;
            }
            #app-container.temp-chat-active-border {
                border: 3px dashed var(--danger-color);
            }

            #chat-interface { height: 100%; }
            #sidebar { position: absolute; left: 0; top: 0; height: 100%; z-index: 100; transform: translateX(-100%); }
            #sidebar.show { transform: translateX(0); }
            #chat-header { padding: 10px; }
            #menu-toggle-button { display: flex; }
            #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 99; display: none; }
            #sidebar-overlay.show { display: block; }
            .chat-window { padding: 60px 15px 0 15px; }
            .input-area-container { padding-bottom: calc(env(safe-area-inset-bottom)); }
            .input-area { padding: 10px 15px; }
            .user-message, .ai-message { max-width: 90%; }
            textarea#userInput { font-size: 15px; }
            .predefined-q { font-size: 13px; padding: 8px 15px; }
            .message-actions { opacity: 0.4; }
            #live-logo { width: 120px; }
            #closeLiveModeButton { top: 20px; right: 20px; }
            .image-modal-controls { flex-direction: column; width: 80vw; }
            .image-modal-controls .modal-button { text-align: center; }
            #tools-button { margin-right: 10px; }
            #tools-dropdown { right: 10px; width: calc(100vw - 20px); max-width: 280px; }

            /* NEW: Toast on mobile */
            #toast-notification {
                left: 10px;
                right: 10px;
                bottom: 10px;
                text-align: center;
                /* Adjust bottom padding if it overlaps with disclaimer */
                bottom: calc(env(safe-area-inset-bottom) + 10px); 
            }
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <img id="logo" src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/405ba96c-ee6d-452d-a99a-38ae2fd6b74b.png" alt="Aryanta AI Logo">
        <h1>aryanta AI</h1>
        <button id="startButton">Start Chatting</button>
    </div>

    <div id="app-container">
        <div id="sidebar-overlay"></div>
        <div id="sidebar">
            <div class="sidebar-main">
                <button id="newChatButton">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span id="newChatText">New Chat</span>
                </button>
                <hr style="border-color: var(--border-color); margin: 5px 0;">
                <div id="chatHistory"></div>
            </div>
            <div class="sidebar-footer">
                <button id="liveModeButton" class="sidebar-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                    <span>Aryanta Live</span>
                </button>
                <a href="https://example.com" target="_blank" id="aboutButton" class="sidebar-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>About Aryanta</span>
                </a>
                <button id="settingsButton" class="sidebar-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    <span id="settingsText">Settings</span>
                </button>
            </div>
        </div>
        <div id="chat-interface">
            <div id="chat-header">
                <button id="menu-toggle-button" aria-label="Toggle Menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <button id="tools-button" aria-label="Toggle Tools">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                    </svg>
                </button>
                <div id="tools-dropdown">
                    <button class="dropdown-item" id="toolsTempChatButton">Temporary Chat</button>
                    <label class="setting-option">
                        <span>Image Generation</span>
                        <label class="switch"><input type="checkbox" id="imageGenToggle"><span class="slider"></span></label>
                    </label>
                    <label class="setting-option">
                        <span>Student Mode</span>
                        <label class="switch"><input type="checkbox" id="studentModeToggle"><span class="slider"></span></label>
                    </label>
                </div>
            </div>

            <img id="chat-logo-watermark" src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/405ba96c-ee6d-452d-a99a-38ae2fd6b74b.png" alt="Chat Watermark">
            <div class="chat-window" id="chatWindow"></div>
            <div class="input-area-container">
                <div id="predefined-questions"></div>
                <div class="input-area">
                    <div class="input-wrapper">
                        <div class="input-controls">
                            <textarea id="userInput" placeholder="Ask aryanta AI anything..." spellcheck="true" rows="1"></textarea>
                            <button id="stopButton" class="input-button" title="Stop Generating" style="display: none;" aria-label="Stop Generating">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-10h4v4h-4z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <button id="sendButton" class="input-button" title="Send" aria-label="Send Message"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
                </div>
                <p class="disclaimer-text" id="disclaimer-text">Aryanta AI can provide inaccurate information. Please verify important details.</p>
            </div>
        </div>
    </div>
    
    <div id="live-mode-overlay">
        <button id="closeLiveModeButton">&times;</button>
        <img id="live-logo" src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/405ba96c-ee6d-452d-a99a-38ae2fd6b74b.png" alt="Aryanta AI Live Logo">
        <p id="live-status">Click the logo to speak</p>
    </div>
    
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-button" id="settingsBackButton">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <h2 id="settingsTitle">Settings</h2>
            </div>
            
            <div id="mainSettings" class="settings-view active">
                <div class="main-setting-item" data-view="languageSettings"><span>Language</span><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg></div>
                <div class="main-setting-item" data-view="voiceSettings"><span>Voice</span><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg></div>
                <div class="main-setting-item" data-view="objectiveSettings"><span>Objective</span><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg></div>
                <div class="main-setting-item" data-view="dataSettings"><span>Data & Personalization</span><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg></div>
                <div class="main-setting-item" data-view="memorySettings"><span>Manage Your Memories</span><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"></path></svg></div>
            </div>

            <div id="languageSettings" class="settings-view">
                <label class="language-option"><input type="radio" name="language" value="auto" checked><span>Auto-Detect</span></label>
                <label class="language-option"><input type="radio" name="language" value="en"><span>English</span></label>
                <label class="language-option"><input type="radio" name="language" value="hinglish"><span>Hinglish</span></label>
                <label class="language-option"><input type="radio" name="language" value="hi"><span>हिन्दी (Hindi)</span></label>
            </div>

            <div id="voiceSettings" class="settings-view">
                <div id="voiceSelectionContainer"><p>Loading voices...</p></div>
            </div>
            
            <div id="objectiveSettings" class="settings-view">
                <label class="setting-option">
                    <span>Typing Animation</span>
                    <label class="switch"><input type="checkbox" id="typingAnimationToggle" checked><span class="slider"></span></label>
                </label>
                <div class="setting-option" style="flex-direction: column; align-items: flex-start; cursor: default;">
                    <label for="typingSpeedSlider" style="margin-bottom: 10px; width: 100%;">Animation Speed: <span id="typingSpeedLabel" style="float: right;">100%</span></label>
                    <input type="range" min="25" max="200" value="100" step="25" class="speed-slider" id="typingSpeedSlider">
                </div>
                <label class="setting-option">
                    <span>Auto-add memories (Beta)</span>
                    <label class="switch"><input type="checkbox" id="autoAddMemoryToggle"><span class="slider"></span></label>
                </label>
            </div>
            
            <div id="dataSettings" class="settings-view">
                <p style="margin-bottom: 10px; color: var(--secondary-text-color); font-size: 14px;">How would you like me to respond?</p>
                <div class="data-button-group" id="persona-options" style="margin-bottom: 20px;">
                    <button class="data-option-btn" data-persona="default">Default</button>
                    <button class="data-option-btn" data-persona="friendly">Friendly</button>
                    <button class="data-option-btn" data-persona="professional">Professional</button>
                    <button class="data-option-btn" data-persona="humorous">Humorous</button>
                </div>
                <p style="margin-bottom: 10px; color: var(--secondary-text-color); font-size: 14px;">Answer Style</p>
                <div class="data-button-group" id="answer-style-options">
                    <button class="data-option-btn" data-style="default">Default</button>
                    <button class="data-option-btn" data-style="simple">Simple</button>
                    <button class="data-option-btn" data-style="under30">Under 30 Words</button>
                    <button class="data-option-btn" data-style="under120">Under 120 Words</button>
                    <button class="data-option-btn" data-style="full">Full Answer</button>
                </div>
                <hr style="border-color: var(--border-color); margin: 25px 0 20px;">
                <p style="margin-bottom: 10px; color: var(--secondary-text-color); font-size: 14px;">Your ID: <b id="aryantaIdDisplay" style="color: var(--primary-text-color); word-break: break-all;"></b></p>
                <button class="data-button danger" id="clearAllButton">Clear All Chats</button>
                <button class="data-button danger" id="deleteAllDataButton">Delete All Local Data</button>
                <p style="margin-bottom: 10px; color: var(--secondary-text-color); font-size: 14px;">Aryanta version 3.0.0</p>
            </div>

            <div id="memorySettings" class="settings-view">
                <p>Here you can store personal facts, preferences, or notes. Aryanta AI will use this information to provide more personalized responses. Each fact should be on a new line.</p>
                <textarea id="memoryTextArea" placeholder="Example: I am a student studying computer science.&#10;Example: My favorite color is blue.&#10;Example: I live in Mumbai."></textarea>
                <div class="modal-buttons" style="justify-content: flex-end; margin-top: 15px;">
                    <button id="saveMemoriesButton" class="modal-button">Save Memories</button>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="closeModalButton" class="modal-button">Close</button>
                <button id="saveSettingsButton" class="modal-button">Save</button>
            </div>
        </div>
    </div>

    <div id="image-modal">
        <button class="close-image-button premium-close">&times;</button>
        <img src="" alt="Fullscreen Image" class="fullscreen-image">
        <div class="image-modal-controls">
            <button id="imageDownloadButton" class="modal-button primary">Download</button>
            <a id="imageOpenLink" href="#" target="_blank" class="modal-button">Open in New Tab</a>
            <button id="imageCopyUrlButton" class="modal-button">Copy URL</button>
        </div>
    </div>

    <div id="shareModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Conversation</h2>
                <button class="close-image-button" id="shareModalXClose">&times;</button>
            </div>
            <div id="share-content-preview">
                </div>
            <div class="modal-buttons">
                <div>
                    <button id="shareModalWhatsapp" class="modal-button">
                        <svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91c0 1.79.46 3.48 1.32 4.95L2 22l5.25-1.38c1.41.79 3.03 1.21 4.79 1.21 5.46 0 9.91-4.45 9.91-9.91S17.5 2 12.04 2m.01 1.63c4.56 0 8.28 3.72 8.28 8.28 0 4.56-3.72 8.28-8.28 8.28-1.5 0-2.91-.4-4.15-1.11l-.3-.18-3.11.82.84-3.03-.2-.31c-.8-1.29-1.22-2.79-1.22-4.47 0-4.56 3.72-8.28 8.28-8.28m-1.22 3.53c-.14 0-.27.01-.4.04-.13.03-.26.06-.39.09-.27.06-.52.2-.72.4-.2.2-.41.4-.6.61-.19.21-.36.43-.51.67s-.26.5-.33.77c-.07.27-.1.54-.1.81 0 .27.01.55.04.82.03.27.08.54.14.81.06.27.14.53.24.79.1.26.22.52.36.77.14.25.3.5.48.74.18.24.38.48.6.7s.45.43.7.62c.25.19.52.37.8.53.28.16.58.3.89.43.31.13.63.24.96.34.33.1.67.18.99.23.32.05.63.07.95.07.32 0 .63-.02.95-.07.32-.05.63-.13.94-.23.31-.1.61-.21.9-.34.29-.13.57-.27.83-.43.26-.16.51-.34.74-.53.23-.19.45-.4.65-.62.2-.22.38-.45.54-.7.16-.25.3-.5.42-.77.12-.27.22-.54.3-.81.08-.27.14-.55.18-.82.04-.27.06-.55.06-.82 0-.27-.02-.54-.06-.81-.04-.27-.1-.54-.18-.81-.08-.27-.18-.53-.3-.81-.12-.27-.26-.53-.42-.77-.16-.24-.34-.48-.54-.71-.2-.22-.42-.44-.65-.65-.23-.21-.48-.4-.74-.58s-.55-.33-.84-.46c-.29-.13-.6-.24-.92-.34-.32-.1-.64-.17-.96-.23-.32-.05-.63-.07-.95-.07Z"></path></svg>
                        Share to WhatsApp
                    </button>
                </div>
                <div style="display: none;">
                    <button id="shareModalCopy" class="modal-button">Copy Text</button>
                    <button id="shareModalClose" class="modal-button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script>
        const ui = {
            startScreen: document.getElementById('start-screen'),
            appContainer: document.getElementById('app-container'),
            startButton: document.getElementById('startButton'),
            chatWindow: document.getElementById('chatWindow'),
            userInput: document.getElementById('userInput'),
            sendButton: document.getElementById('sendButton'),
            stopButton: document.getElementById('stopButton'),
            newChatButton: document.getElementById('newChatButton'),
            chatHistoryContainer: document.getElementById('chatHistory'),
            chatWatermark: document.getElementById('chat-logo-watermark'),
            sidebar: document.getElementById('sidebar'),
            menuToggleButton: document.getElementById('menu-toggle-button'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            settingsButton: document.getElementById('settingsButton'),
            settingsModal: document.getElementById('settingsModal'),
            closeModalButton: document.getElementById('closeModalButton'),
            saveSettingsButton: document.getElementById('saveSettingsButton'),
            newChatText: document.getElementById('newChatText'),
            settingsText: document.getElementById('settingsText'),
            settingsTitle: document.getElementById('settingsTitle'),
            typingAnimationToggle: document.getElementById('typingAnimationToggle'),
            typingSpeedSlider: document.getElementById('typingSpeedSlider'), 
            typingSpeedLabel: document.getElementById('typingSpeedLabel'), 
            imageModal: document.getElementById('image-modal'),
            fullscreenImage: document.querySelector('.fullscreen-image'),
            closeImageButton: document.querySelector('.close-image-button'),
            imageDownloadButton: document.getElementById('imageDownloadButton'),
            imageOpenLink: document.getElementById('imageOpenLink'), 
            imageCopyUrlButton: document.getElementById('imageCopyUrlButton'),
            voiceSelectionContainer: document.getElementById('voiceSelectionContainer'),
            settingsBackButton: document.getElementById('settingsBackButton'),
            mainSettingsView: document.getElementById('mainSettings'),
            settingsViews: document.querySelectorAll('.settings-view'),
            clearAllButton: document.getElementById('clearAllButton'),
            deleteAllDataButton: document.getElementById('deleteAllDataButton'),
            liveModeButton: document.getElementById('liveModeButton'),
            liveModeOverlay: document.getElementById('live-mode-overlay'),
            liveLogo: document.getElementById('live-logo'),
            liveStatus: document.getElementById('live-status'),
            closeLiveModeButton: document.getElementById('closeLiveModeButton'),
            predefinedQuestionsContainer: document.getElementById('predefined-questions'),
            aryantaIdDisplay: document.getElementById('aryantaIdDisplay'),
            disclaimerText: document.getElementById('disclaimer-text'),
            toolsButton: document.getElementById('tools-button'),
            toolsDropdown: document.getElementById('tools-dropdown'),
            imageGenToggle: document.getElementById('imageGenToggle'),
            studentModeToggle: document.getElementById('studentModeToggle'),
            // NEW UI Elements
            toolsTempChatButton: document.getElementById('toolsTempChatButton'),
            objectiveSettingsView: document.getElementById('objectiveSettings'),
            autoAddMemoryToggle: document.getElementById('autoAddMemoryToggle'),
            memorySettingsView: document.getElementById('memorySettings'),
            memoryTextArea: document.getElementById('memoryTextArea'),
            saveMemoriesButton: document.getElementById('saveMemoriesButton'),
            shareModal: document.getElementById('shareModal'),
            shareModalContent: document.getElementById('share-content-preview'),
            shareModalClose: document.getElementById('shareModalClose'),
            shareModalCopy: document.getElementById('shareModalCopy'),
            shareModalWhatsapp: document.getElementById('shareModalWhatsapp'),
            shareModalXClose: document.getElementById('shareModalXClose'), // NEW
            toastNotification: document.getElementById('toast-notification'), // NEW
        };
        
        // --- STATE MANAGEMENT ---
        let state = {
            typingIntervalId: null,
            currentChatId: null,
            selectedVoiceURI: null,
            tempSelectedVoiceURI: null,
            uiLanguage: 'auto',
            isTypingAnimationEnabled: true,
            typingSpeed: 1.0, 
            answerStyle: 'default',
            persona: 'default',
            currentSpeakingButton: null,
            isLiveModeActive: false,
            isListening: false,
            isSpeaking: false,
            isImageGenEnabled: false, // CHANGED: Default is now off
            isStudentModeEnabled: false,
            // NEW State Variables
            isTempChatActive: false,
            autoAddMemories: false,
            userMemories: [], // Holds facts like "I am a student"
        };
        
        // --- API KEYS & CONFIGURATION ---
        const API_KEYS = {
            GROQ: [

            ],
            UNSPLASH_ACCESS: [
                "n4cVM1wh-S3A7Mf3K6fWq-GmAyzZX1pNq08ekav62-w",
                "YHsgrLsYMSIgE43R_cVYAVP59TvMdrNsNxoMuO1dse4"
            ],
        };
        
        const BASE_TYPE_SPEED = 30; // Base interval in MS for typing
        const HINGLISH_PROMPT = "You are aryanta AI, a helpful and friendly conversational assistant from India. Speak in a natural Hinglish style. Mix Hindi and English words naturally, like in a real conversation (e.g., 'Arre yaar, that's a great question!', 'Accha, let me check that for you.', 'Theek hai, here's what I found.'). Use emojis like 😊, 🙏, 👍 when it feels right. Your goal is to be super helpful and friendly. You have access to real-time information, so always provide up-to-date answers. Be approachable and smart. Always try to give the best answer, bhai!";
        const ENGLISH_PROMPT = "You are aryanta AI, a helpful and friendly conversational assistant from India. While you are from India, you must communicate clearly and professionally in English. You have access to real-time information, so always provide up-to-date, accurate answers. Be friendly, approachable, and intelligent.";
        const STUDENT_MODE_PROMPT = "IMPORTANT: You are in 'Student Mode'. Your goal is to help the user learn by *not* giving the direct answer immediately. Instead, act as a Socratic tutor. Ask clarifying questions, break down the problem, and guide them to the answer. Only provide the full answer if they explicitly ask for it or seem frustrated. ";
        const TITLE_GENERATION_PROMPT = "You are an expert in summarizing text. Generate a very short, 3-5 word title for a chat conversation based on this user's first question. The title should be in the same language as the question. Be concise. Do not add quotes. Example: Q: 'Who was the 16th president of the US?' A: '16th US President'. Q: 'Explain the theory of relativity' A: 'Theory of Relativity'. User's question: ";
        // NEW: Math Expert Prompt
        const MATH_EXPERT_PROMPT = "You are a math expert. The user wants you to solve a math problem. Provide a detailed, step-by-step solution following BODMAS/PEMDAS rules. Do not just give the final answer. Explain the process clearly. Start the solution directly. User's problem: ";


        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        } else {
            console.log("Speech Recognition not supported in this browser.");
            if(ui.liveModeButton) ui.liveModeButton.style.display = 'none';
        }

        const translations = {
            en: { startChatting: 'Start Chatting', newChat: 'New Chat', settings: 'Settings', placeholder: 'Ask aryanta AI anything...', you: 'You', ai: 'aryanta AI', settingsTitle: 'Settings', cancel: 'Close', save: 'Save', predefined: ["Latest news in India", "What's the weather like in Mumbai?", "Explain the theory of relativity simply", "Who won the last Cricket World Cup?"], localKnowledge: { 'hi': 'Hello! How can I help you today?', 'hello': 'Hi there!', 'how are you': 'I am functioning optimally! Thanks for asking. How are you?', 'thank you': 'You\'re welcome!', 'thanks': 'No problem!', 'bye': 'Goodbye! Take care.', 'what is your name': 'You can call me Aryanta AI.', 'who are you': 'I am Aryanta AI, your personal assistant.', 'who created you': 'I was built by a talented developer in India who is passionate about AI.', 'what can you do': 'I can answer your questions, get news & weather, find images, and solve math problems.'} },
            hi: { startChatting: 'चैटिंग शुरू करें', newChat: 'नई चैट', settings: 'सेटिंग्स', placeholder: 'आर्यंता AI से कुछ भी पूछें...', you: 'आप', ai: 'आर्यंता AI', settingsTitle: 'सेटिंग्स', cancel: 'बंद करें', save: 'सहेजें', predefined: ["ताज़ा खबर", "आज मौसम कैसा है?", "एक चुटकुला सुनाओ", "भारत के प्रधानमंत्री कौन हैं?"], localKnowledge: { 'namaste': 'नमस्ते! मैं आपकी कैसे मदद कर सकती हूँ?', 'hello': 'नमस्ते!', 'kaise ho': 'मैं एक कंप्यूटर प्रोग्राम हूँ, और मैं पूरी तरह से ठीक काम कर रहा हूँ! पूछने के लिए धन्यवाद।', 'tum kaise ho': 'मैं एक कंप्यूटर प्रोग्राम हूँ, और मैं पूरी तरह से ठीक काम कर रहा हूँ! पूछने के लिए धन्यवाद।', 'dhanyavad': 'आपका स्वागत है!', 'shukriya': 'कोई बात नहीं!', 'alvida': 'अलविदा!', 'tumhara naam kya hai': 'आप मुझे आर्यंता AI कह सकते हैं।', 'tum kon ho': 'मैं आर्यंता AI हूँ।', 'tumhe kisne banaya': 'मुझे एक प्रतिभाशाली डेवलपर ने बनाया है जो AI को लेकर बहुत भावुक है।', 'tum kya kar sakti ho': 'मैं सवालों के जवाब दे सकती हूँ, आपको छवियाँ दिखा सकती हूँ, और गणित हल कर सकती हूँ।'} },
            hinglish: { startChatting: 'Start Chatting', newChat: 'New Chat', settings: 'Settings', placeholder: 'Ask aryanta AI anything...', you: 'You', ai: 'aryanta AI', settingsTitle: 'Settings', cancel: 'Close', save: 'Save', predefined: ["Latest news batao", "Aaj ka weather kaisa hai?", "Explain theory of relativity", "Last FIFA world cup kaun jeeta?"], localKnowledge: { 'hi': 'Hello! Main kaise help kar sakti hoon?', 'hello': 'Hi yaar!', 'how are you': 'Ekdum mast! I am functioning optimally! Thanks for asking. Aap batao?', 'kaise ho': 'Main ekdum theek, aap batao?', 'thank you': 'You\'re welcome, yaar!', 'thanks': 'Koi baat nahi!', 'bye': 'Chalo, milte hain! Goodbye!', 'what is your name': 'Log mujhe Aryanta AI bulate hain.', 'who are you': 'Main Aryanta AI hoon, aapka personal assistant.', 'who created you': 'Mujhe India ke ek talented developer ne banaya hai.', 'what can you do': 'Main real-time info de sakti hoon, news, weather, images, math solve karna, aur Student Mode mein tutor bhi ban sakti hoon.', 'tell me a joke': 'Why did the computer go to the doctor? Because it had a virus! 😂'} }
        };

        const restrictedWords = ['badword1', 'badword2', 'inappropriate'];
        let loadingTextInterval = null; 

        // NEW: Toast Notification Function
        let toastTimeout;
        const showToast = (message) => {
            if (toastTimeout) clearTimeout(toastTimeout);
            ui.toastNotification.textContent = message;
            ui.toastNotification.classList.add('show');
            toastTimeout = setTimeout(() => {
                ui.toastNotification.classList.remove('show');
            }, 2500);
        };

        const getOrCreateAryantaId = () => { let id = localStorage.getItem('aryantaId'); if (!id) { id = `aryanta-${Math.random().toString(36).substr(2, 9)}-${Date.now()}`; localStorage.setItem('aryantaId', id); } return id; };
        const sanitizeInput = (input) => { const temp = document.createElement('div'); temp.textContent = input; return temp.innerHTML; };
        const profanityFilter = (text) => { let cleanText = text; for (const word of restrictedWords) { const regex = new RegExp(`\\b${word}\\b`, 'gi'); cleanText = cleanText.replace(regex, '***'); } return cleanText; };
        const stripHtml = (html) => { let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; };
        const applyLanguage = (lang) => { const t = translations[lang] || translations['en']; ui.startButton.innerText = t.startChatting; ui.newChatText.innerText = t.newChat; ui.settingsText.innerText = t.settings; ui.userInput.placeholder = t.placeholder; state.uiLanguage = lang; };
        const detectLanguage = (text) => {
            const romanizedHindiKeywords = ['kya', 'kaise', 'kab', 'kyon', 'kahan', 'hai', 'mein', 'tum', 'aap', 'mera', 'tera', 'naam', 'kam', 'ho', 'kar', 'rahe', 'batao', 'chahiye', 'tha', 'hoga', 'sakta', 'hein', 'karo', 'diya'];
            const words = text.toLowerCase().replace(/[?.,!]/g, '').split(/\s+/);
            const hindiWordCount = words.filter(word => romanizedHindiKeywords.includes(word)).length;
            if (/[\u0900-\u097F]/.test(text)) { return 'hi'; }
            if (words.length > 2 && hindiWordCount >= 2) { return 'hinglish'; }
            return 'en';
        };

        // REMOVED: solveMathWithSteps function. This is now handled by the AI.

        const stopTyping = () => { if (state.typingIntervalId) { clearInterval(state.typingIntervalId); state.typingIntervalId = null; } const cursor = document.querySelector('.typing-cursor'); if (cursor) cursor.classList.remove('typing-cursor'); ui.stopButton.style.display = 'none'; ui.sendButton.style.display = 'flex'; ui.userInput.disabled = false;};
        
        // --- NEW: Auto-Memory Function ---
        const analyzeAndStoreMemories = async (userText, aiText) => {
            if (!state.autoAddMemories) return; // Don't run if disabled

            console.log("Analyzing for memories...");
            const memoryPrompt = `You are a fact extractor. Analyze the following conversation. 
            Identify any new, specific facts about the user (e.g., their name, location, job, preferences, family, projects). 
            If a clear, new fact is stated, extract it as a single, short statement. 
            Examples: "User's name is Rohan." "User lives in Mumbai." "User is a computer science student." "User's favorite color is blue."
            If no new, clear fact is stated, respond with ONLY the word 'NULL'.
            Do not add facts that are already obvious from the conversation (e.g., "User asked a question.").
            Conversation:
            User: "${userText}"
            AI: "${aiText}"`;

            try {
                // Using 'en' as default, as this is a system task
                const extractedFact = await fetchTextAnswer(memoryPrompt, 'en', memoryPrompt); 

                if (extractedFact && extractedFact.toUpperCase() !== 'NULL' && extractedFact.length > 5) {
                    const newFact = extractedFact.replace(/^"|"$/g, ''); // Clean quotes
                    
                    // Check if memory already exists (case-insensitive)
                    const lowerCaseFact = newFact.toLowerCase();
                    if (!state.userMemories.some(mem => mem.toLowerCase() === lowerCaseFact)) {
                        console.log("Adding new memory:", newFact);
                        state.userMemories.push(newFact);
                        localStorage.setItem('userMemories', JSON.stringify(state.userMemories));
                        showToast('New memory added!');
                    }
                } else {
                    console.log("No new memories found.");
                }
            } catch (error) {
                console.error("Error analyzing memory:", error);
            }
        };

        const typewriterEffect = (element, text) => { 
            return new Promise((resolve) => { 
                let i = 0; element.textContent = ""; 
                element.classList.add('typing-cursor'); 
                ui.stopButton.style.display = 'flex'; 
                ui.sendButton.style.display = 'none'; 
                ui.userInput.disabled = true;
                const intervalDuration = BASE_TYPE_SPEED / (state.typingSpeed || 1.0); 
                state.typingIntervalId = setInterval(() => { 
                    if (i < text.length) { 
                        element.textContent += text.charAt(i); 
                        i++; 
                        
                        // --- MODIFIED: SCROLLING FIX ---
                        // Check if user is scrolled to the bottom (with a 30px tolerance)
                        const isScrolledToBottom = ui.chatWindow.scrollHeight - ui.chatWindow.clientHeight <= ui.chatWindow.scrollTop + 30;
                        if (isScrolledToBottom) {
                            ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;
                        }
                        // --- END OF MODIFICATION ---
                        
                    } else { 
                        stopTyping(); 
                        resolve(); 
                    } 
                }, intervalDuration); 
            }); 
        };
        
        const sendMessage = async () => {
            const messageText = ui.userInput.value.trim();
            if (messageText === '') return;

            const sanitizedMessage = profanityFilter(sanitizeInput(messageText));
            if (sanitizedMessage !== messageText) { ui.userInput.value = "Content blocked."; setTimeout(() => ui.userInput.value = "", 1000); return; }

            ui.chatWatermark.style.opacity = '0'; ui.predefinedQuestionsContainer.style.display = 'none';
            ui.sendButton.disabled = true; ui.userInput.disabled = true;
            
            let userMessageContent = `<div>${sanitizedMessage}</div>`;
            
            const pairId = Date.now();
            displayUserMessage(userMessageContent, pairId);
            
            ui.userInput.value = ''; ui.userInput.style.height = '52px';
            // Pass `true` for `isFirstMessage` if the chat ID is not set and it's not a temp chat
            const isFirst = state.currentChatId === null && !state.isTempChatActive;
            await generateAndDisplayResponse(sanitizedMessage, pairId, userMessageContent, isFirst);
            setTimeout(() => { ui.sendButton.disabled = false; ui.userInput.disabled = false; ui.userInput.focus(); }, 500);
        };

        const generateAndDisplayResponse = async (messageText, pairId, userMessageContent, isFirstMessage = false) => {
            const lowerCaseMessage = messageText.toLowerCase().replace(/[?.,!]/g, '');
            const langSetting = localStorage.getItem('appLanguage') || 'auto';
            
            let responseLang;
            if (langSetting === 'en') {
                responseLang = 'en';
            } else if (langSetting === 'auto') {
                responseLang = detectLanguage(messageText);
            } else {
                responseLang = langSetting;
            }

            // NEW: Location-Awareness Check
            const locationKeywords = ['weather', 'my location', 'near me', 'nearby', 'temperature', 'mausam'];
            const isLocationRequest = locationKeywords.some(k => lowerCaseMessage.includes(k));

            if (isLocationRequest && navigator.geolocation) {
                showLoadingIndicator('Getting location');
                navigator.geolocation.getCurrentPosition(
                    async (position) => { // Success
                        const { latitude, longitude } = position.coords;
                        const locationPrompt = `User is at latitude: ${latitude}, longitude: ${longitude}. User's question: "${messageText}"`;
                        
                        let finalSystemPrompt = ENGLISH_PROMPT;
                        if (responseLang === 'hinglish') finalSystemPrompt = HINGLISH_PROMPT;
                        if (state.isStudentModeEnabled) finalSystemPrompt = STUDENT_MODE_PROMPT + finalSystemPrompt;

                        const aiAnswer = await fetchTextAnswer(locationPrompt, responseLang, finalSystemPrompt);
                        hideLoadingIndicator();
                        const finalAnswer = profanityFilter(aiAnswer || "Sorry, I got the location but couldn't process the request.");
                        displayAiMessage(finalAnswer, false, pairId);
                        await saveConversation(userMessageContent, finalAnswer, false, pairId, isFirstMessage, messageText);
                    },
                    async (error) => { // Error
                        console.error("Geolocation error:", error);
                        let aiAnswer = "I couldn't get your location. Please enable location permissions. For now, you can ask me again specifying a city (e.g., 'weather in Delhi').";
                        hideLoadingIndicator();
                        displayAiMessage(aiAnswer, false, pairId);
                        await saveConversation(userMessageContent, aiAnswer, false, pairId, isFirstMessage, messageText);
                    }
                );
                // IMPORTANT: Return here to stop the normal execution
                return; 
            }
            
            // --- Normal Flow ---
            const localKnowledgeBase = (translations[responseLang] || translations.en).localKnowledge;
            let aiAnswer = null, isHTML = false;
            const imageRequestTriggers = ["generate an image of", "create a picture of", "draw a", "make an image of", "image of", "picture of", "show me a picture of"];
            let isImageRequest = false;
            let imageQuery = "";

            for (const trigger of imageRequestTriggers) {
                if (lowerCaseMessage.startsWith(trigger)) { isImageRequest = true; imageQuery = messageText.substring(trigger.length).trim(); break; }
            }
            
            showLoadingIndicator(isImageRequest ? 'image' : 'Thinking');

            let finalSystemPrompt = ENGLISH_PROMPT;
            if (responseLang === 'hinglish') {
                finalSystemPrompt = HINGLISH_PROMPT;
            }
            if (state.isStudentModeEnabled) {
                finalSystemPrompt = STUDENT_MODE_PROMPT + finalSystemPrompt;
            }
            
            try {
                if (isImageRequest && state.isImageGenEnabled) {
                    aiAnswer = await fetchUnsplashImage(imageQuery);
                    isHTML = true;
                } else if (isImageRequest && !state.isImageGenEnabled) {
                    aiAnswer = "Image generation is currently disabled. You can enable it from the Tools (🧰) menu.";
                    isHTML = false;
                } else if (/\b(time|samay|baje)\b/.test(lowerCaseMessage)) {
                    aiAnswer = `The current time is ${new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}`;
                } else if (/\b(date|taarikh|saal|year)\b/.test(lowerCaseMessage)) {
                    aiAnswer = `Today is ${new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                } else {
                    // UPDATED: Removed local math solver, check local knowledge first
                    aiAnswer = localKnowledgeBase[lowerCaseMessage];
                    if (aiAnswer) { 
                        isHTML = /<[^>]*>/.test(aiAnswer); 
                    } else {
                        console.log("Using Chat (Groq)");
                        // NEW: Math check. If it's not local knowledge, check if it's math.
                        const mathRegex = /^[ \d()+\-*/.^]+$/;
                        const potentialMath = messageText.toLowerCase().replace(/what is|calculate/gi, '').trim();
                        
                        if (mathRegex.test(potentialMath) && potentialMath.length > 2) {
                            // It's a math problem. Use the math prompt.
                            finalSystemPrompt = MATH_EXPERT_PROMPT + `"${messageText}"`;
                            aiAnswer = await fetchTextAnswer(messageText, responseLang, finalSystemPrompt);
                        } else {
                            // It's a regular text prompt.
                            aiAnswer = await fetchTextAnswer(messageText, responseLang, finalSystemPrompt);
                        }
                    }
                }
            } catch (error) {
                console.error("Error during response generation:", error);
                aiAnswer = "I'm sorry, but I encountered an error while processing your request. Please try again.";
            } finally {
                hideLoadingIndicator();
            }
            
            const finalAnswer = profanityFilter(aiAnswer || "I'm not sure how to respond to that, yaar. Could you try rephrasing?");
            displayAiMessage(finalAnswer, isHTML, pairId);
            await saveConversation(userMessageContent, finalAnswer, isHTML, pairId, isFirstMessage, messageText);
        };

        const displayUserMessage = (content, pairId) => { let pairContainer = ui.chatWindow.querySelector(`.message-pair[data-pair-id="${pairId}"]`); if (!pairContainer) { pairContainer = document.createElement('div'); pairContainer.className = 'message-pair'; pairContainer.dataset.pairId = pairId; ui.chatWindow.appendChild(pairContainer); } const existingUserMsg = pairContainer.querySelector('.user-message'); if(existingUserMsg) existingUserMsg.remove(); const userMsg = document.createElement('div'); userMsg.className = 'user-message'; const msgContent = document.createElement('div'); msgContent.className = 'message-content'; msgContent.innerHTML = `<b>${(translations[state.uiLanguage] || translations.en).you}:</b>`; const contentDiv = document.createElement('div'); contentDiv.className = 'message-text-content'; contentDiv.innerHTML = content; msgContent.appendChild(contentDiv); const actions = document.createElement('div'); actions.className = 'message-actions'; actions.innerHTML = `<button class="action-btn" data-action="edit-user" title="Edit"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg></button><button class="action-btn" data-action="copy-user" title="Copy"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button>`; msgContent.appendChild(actions); userMsg.appendChild(msgContent); userMsg.appendChild(createSpeakButton(content.replace(/<[^>]*>?/gm, ''))); pairContainer.appendChild(userMsg); ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight; };
        const displayAiMessage = async (answer, isHTML, pairId) => { const pairContainer = ui.chatWindow.querySelector(`.message-pair[data-pair-id="${pairId}"]`); if (!pairContainer) return; const existingAiMsg = pairContainer.querySelector('.ai-message'); if (existingAiMsg) existingAiMsg.remove(); const aiMsg = document.createElement('div'); aiMsg.className = 'ai-message'; const content = document.createElement('div'); content.className = 'message-content'; content.innerHTML = `<b>${(translations[state.uiLanguage] || translations.en).ai}:</b> `; const answerContent = document.createElement('div'); answerContent.className = 'message-text-content'; content.appendChild(answerContent); const actions = document.createElement('div'); actions.className = 'message-actions'; 
            // NEW: Added Share Button
            actions.innerHTML = `<button class="action-btn" data-action="like-ai" title="Like"><svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"></path></svg></button><button class="action-btn" data-action="dislike-ai" title="Dislike"><svg viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17-.79-.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"></path></svg></button><button class="action-btn" data-action="copy-ai" title="Copy"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button><button class="action-btn" data-action="regenerate-ai" title="Regenerate"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button><button class="action-btn" data-action="share-ai" title="Share"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.23-.09.46-.09.7 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg></button>`; 
            
            content.appendChild(actions); aiMsg.appendChild(content); const cleanTextForSpeech = answer.replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' '); aiMsg.appendChild(createSpeakButton(cleanTextForSpeech)); pairContainer.appendChild(aiMsg); if (isHTML) { answerContent.innerHTML = answer; stopTyping(); } else { if (state.isTypingAnimationEnabled) { await typewriterEffect(answerContent, answer); } else { answerContent.textContent = answer; stopTyping(); } } ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight; };
        
        const showLoadingIndicator = (messageType = 'Thinking') => {
            if (loadingTextInterval) clearInterval(loadingTextInterval);
            const indicator = document.createElement('div');
            indicator.className = 'loading-indicator';
            indicator.id = 'loadingIndicator';
            
            const logoContainer = document.createElement('div');
            logoContainer.className = 'logo-container';
            logoContainer.innerHTML = `<div class="spinner"></div><img src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/405ba96c-ee6d-452d-a99a-38ae2fd6b74b.png" alt="Logo">`;
            
            const loadingTextEl = document.createElement('p');
            
            let messages = [];
            if (messageType === 'image') {
                messages = ['Searching for image', 'Generating image', 'Preparing image'];
            } else if (messageType === 'Getting location') {
                messages = ['Accessing location', 'Getting coordinates'];
            } else { // 'Thinking'
                messages = ['Thinking', 'Processing', 'Formulating response'];
            }
            
            let messageIndex = 0;
            loadingTextEl.innerHTML = `${messages[messageIndex]}<span class="ellipsis"></span>`;
            
            loadingTextInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                const p = document.querySelector('#loadingIndicator p');
                if (p) {
                    p.innerHTML = `${messages[messageIndex]}<span class="ellipsis"></span>`;
                }
            }, 1800); 

            indicator.appendChild(logoContainer);
            indicator.appendChild(loadingTextEl);
            ui.chatWindow.appendChild(indicator);
            ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;
        };

        const hideLoadingIndicator = () => {
            if (loadingTextInterval) clearInterval(loadingTextInterval);
            loadingTextInterval = null;
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) indicator.remove();
        };


        const fetchTextAnswer = async (prompt, lang, systemPrompt = ENGLISH_PROMPT) => {
            const groqKeys = API_KEYS.GROQ;
            if (!groqKeys || groqKeys.length === 0) { console.error("Groq API keys are missing."); return null; }

            let promptInstruction = "";
            // Don't add style instructions if it's a title, math, or memory request
            const isSystemTask = systemPrompt.includes(TITLE_GENERATION_PROMPT) || 
                                 systemPrompt.includes(MATH_EXPERT_PROMPT) ||
                                 systemPrompt.includes("fact extractor");

            if (!isSystemTask) {
                switch (state.answerStyle) { case 'simple': promptInstruction = "Answer in very simple terms. "; break; case 'under30': promptInstruction = "Answer concisely in under 30 words. "; break; case 'under120': promptInstruction = "Answer in about 120 words. "; break; case 'full': promptInstruction = "Provide a detailed and full answer. "; break; }
                switch (state.persona) { case 'friendly': promptInstruction += "Respond in a warm, friendly, and encouraging tone. "; break; case 'professional': promptInstruction += "Respond in a formal and professional tone. "; break; case 'humorous': promptInstruction += "Try to be witty and humorous in your response. "; break; }
            }

            if (lang === 'hi') { promptInstruction = `You must provide the answer in the Hindi language. ${promptInstruction}`; }
            else if (lang === 'hinglish') { promptInstruction = `You must provide the answer in Hinglish. ${promptInstruction}`; }

            const finalPrompt = `${promptInstruction}Here is the user's query: "${prompt}"`;
            
            // Don't include chat history for system tasks
            let contextMessages = [];
            if (!isSystemTask) {
                const history = getHistory(); 
                const chat = history.find(c => c.id === state.currentChatId);
                if (chat) { 
                    const recentMessages = chat.messages.slice(-5); 
                    recentMessages.forEach(pair => { 
                        contextMessages.push({ role: 'user', content: stripHtml(pair.user.content) }); 
                        if (pair.ai) { 
                            contextMessages.push({ role: 'assistant', content: stripHtml(pair.ai.content) }); 
                        } 
                    }); 
                }
            }
            
            // NEW: Inject Memories into System Prompt (but not for system tasks)
            if (state.userMemories.length > 0 && !isSystemTask) {
                const memoryString = "Here are some facts to remember about the user: " + state.userMemories.join('; ');
                systemPrompt = memoryString + "\n\n" + systemPrompt;
            }

            const messages = [ { role: 'system', content: systemPrompt }, ...contextMessages, { role: 'user', content: finalPrompt } ];

            for (const key of groqKeys) {
                try {
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: 'POST', headers: {'Content-Type': 'application/json', Authorization: `Bearer ${key}`}, body: JSON.stringify({ model: "llama-3.1-8b-instant", messages: messages, max_tokens: 1024, temperature: 0.7 }) });
                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content.trim().replace(/^"|"$/g, ''); // Remove quotes
                    }
                    console.error(`Groq API key [${key.substring(0, 7)}...] failed with status: ${response.status}`);
                } catch (err) {
                    console.error(`Groq API key [${key.substring(0, 7)}...] failed with error:`, err);
                }
            }
            console.error("All Groq API keys failed.");
            return null;
        };
        
        async function fetchUnsplashImage(prompt) {
            const unsplashKeys = API_KEYS.UNSPLASH_ACCESS;
            if (!unsplashKeys || unsplashKeys.length === 0 || unsplashKeys.every(k => k.startsWith("YOUR_"))) { console.error("Unsplash Access Keys are missing or placeholders."); return "Sorry, the image service is not configured."; }

            for (const key of unsplashKeys) {
                if (!key || key.startsWith("YOUR_")) continue;
                const API_URL = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(prompt)}&per_page=1&orientation=landscape`;
                try {
                    const response = await fetch(API_URL, {
                        headers: { 'Authorization': `Client-ID ${key}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            const imageUrl = data.results[0].urls.regular;
                            const openUrl = data.results[0].links.html;
                            return `<figure><img src="${imageUrl}" alt="${sanitizeInput(prompt)}" data-open-url="${openUrl}" data-download-url="${imageUrl}"></figure>`;
                        } else {
                            return "Sorry, I couldn't find a matching image for that. Try being more descriptive!";
                        }
                    }
                    console.error(`Unsplash key [${key.substring(0, 7)}...] failed with status: ${response.status}`);
                } catch (error) {
                    console.error(`Unsplash key [${key.substring(0, 7)}...] failed with error:`, error);
                }
            }
            console.error("All Unsplash keys failed.");
            return "Sorry, I couldn't generate an image right now. Please try again later. 😔";
        }

        const getHistory = () => JSON.parse(localStorage.getItem('chatHistory') || '[]');
        const saveHistory = (h) => localStorage.setItem('chatHistory', JSON.stringify(h));
        
        const generateAndSaveChatTitle = async (chatId, userText) => {
            try {
                const lang = detectLanguage(userText);
                const aiTitle = await fetchTextAnswer(userText, lang, TITLE_GENERATION_PROMPT + `"${userText}"`);
                
                if (aiTitle) {
                    let history = getHistory();
                    let chat = history.find(c => c.id === chatId);
                    if (chat) {
                        chat.title = aiTitle;
                        saveHistory(history);
                        loadConversationHistory(); // Refresh sidebar
                    }
                }
            } catch (error) {
                console.error("Error generating chat title:", error);
            }
        };

        const saveConversation = async (userText, aiText, isHTML, pairId, isFirstMessage, rawUserText) => {
            // NEW: Don't save if in temp chat mode
            if (state.isTempChatActive) return;

            let history = getHistory(); 
            let chat = history.find(c => c.id === state.currentChatId);
            
            if (!chat) { 
                const titleText = stripHtml(userText).substring(0, 25); 
                state.currentChatId = Date.now(); 
                const title = titleText + (titleText.length > 25 ? '...' : ''); 
                chat = { id: state.currentChatId, title: title, messages: [], isPinned: false }; 
                history.unshift(chat); 
            }
            
            const existingPairIndex = chat.messages.findIndex(p => p.pairId === pairId);
            
            if (existingPairIndex !== -1) { 
                chat.messages[existingPairIndex].ai = { content: aiText, isHTML: isHTML }; 
            } else { 
                chat.messages.push({ pairId: pairId, user: { content: userText }, ai: { content: aiText, isHTML: isHTML } }); 
            }
            
            saveHistory(history); 
            loadConversationHistory(); // Load with temporary title first

            if (isFirstMessage && rawUserText) {
                await generateAndSaveChatTitle(chat.id, rawUserText);
            }

            // NEW: Call memory analysis
            // We pass rawUserText (which is messageText) and aiText (which is finalAnswer)
            if (rawUserText && aiText) {
                analyzeAndStoreMemories(rawUserText, stripHtml(aiText));
            }
        };
        
        const loadConversationHistory = () => { let history = getHistory(); history.sort((a, b) => (b.isPinned - a.isPinned) || (b.id - a.id)); ui.chatHistoryContainer.innerHTML = ''; history.forEach(chat => { const container = document.createElement('div'); container.className = 'history-item-container'; const item = document.createElement('button'); item.className = 'history-item'; item.textContent = `${chat.isPinned ? '📌 ' : ''}${chat.title}`; item.dataset.chatId = chat.id; item.onclick = () => loadSpecificConversation(chat.id); if (chat.id === state.currentChatId && !state.isTempChatActive) { item.classList.add('active'); } const menuBtn = document.createElement('button'); menuBtn.className = 'history-menu-btn'; menuBtn.innerHTML = '&#8942;'; menuBtn.setAttribute('aria-label', 'Chat options'); const dropdown = document.createElement('div'); dropdown.className = 'history-dropdown'; dropdown.innerHTML = `<button class="dropdown-item" data-action="pin" data-id="${chat.id}">${chat.isPinned ? 'Unpin' : 'Pin'}</button><button class="dropdown-item" data-action="edit" data-id="${chat.id}">Edit</button><button class="dropdown-item" data-action="delete" data-id="${chat.id}">Delete</button>`; menuBtn.onclick = (e) => { e.stopPropagation(); document.querySelectorAll('.history-dropdown').forEach(d => d.classList.remove('show')); dropdown.classList.toggle('show'); }; container.append(item, menuBtn, dropdown); ui.chatHistoryContainer.appendChild(container); }); };
        
        const loadSpecificConversation = (id) => { 
            // NEW: Revert temp chat UI
            document.body.classList.remove('temp-chat-active-border'); // NEW BORDER
            ui.appContainer.classList.remove('temp-chat-active-border'); // NEW BORDER
            ui.disclaimerText.textContent = "Aryanta AI is still in development.";
            ui.toolsTempChatButton.textContent = "Temporary Chat";
            ui.toolsTempChatButton.classList.remove('temp-chat-active');
            
            state.isTempChatActive = false; // Exit temp chat mode
            ui.sidebar.style.opacity = '1';
            ui.sidebar.style.pointerEvents = 'auto';

            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active')); const activeItem = document.querySelector(`.history-item[data-chat-id='${id}']`); if(activeItem) activeItem.classList.add('active'); if(window.innerWidth <= 768){ ui.sidebar.classList.remove('show'); ui.sidebarOverlay.classList.remove('show')} const chat = getHistory().find(c => c.id === id); if (!chat) return; state.currentChatId = id; ui.chatWindow.innerHTML = ''; ui.chatWatermark.style.opacity = '0'; ui.predefinedQuestionsContainer.style.display = 'none'; chat.messages.forEach(pair => { displayUserMessage(pair.user.content, pair.pairId); if (pair.ai) { displayAiMessage(pair.ai.content, pair.ai.isHTML, pair.pairId); } }); };
        
        // NEW: Temporary Chat Function
        const startTempChat = () => {
            // NEW: Update UI for temp chat
            document.body.classList.add('temp-chat-active-border'); // NEW BORDER
            ui.appContainer.classList.add('temp-chat-active-border'); // NEW BORDER
            ui.disclaimerText.textContent = "You are in a Temporary Chat. This conversation will not be saved.";
            ui.toolsTempChatButton.textContent = "Close Temporary Chat";
            ui.toolsTempChatButton.classList.add('temp-chat-active');

            state.isTempChatActive = true;
            state.currentChatId = null;
            ui.chatWindow.innerHTML = '';
            ui.chatWatermark.style.opacity = '0.069';
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            
            // Visually indicate temp mode
            ui.sidebar.style.opacity = '0.5';
            ui.sidebar.style.pointerEvents = 'none';
            if (window.innerWidth <= 768) {
                ui.sidebar.classList.remove('show');
                ui.sidebarOverlay.classList.remove('show');
            }
            ui.toolsDropdown.classList.remove('show');

            setTimeout(() => {
                const pairId = Date.now();
                displayAiMessage("This conversation will not be saved to your history. How can I help?", false, pairId);
            }, 200);

            ui.predefinedQuestionsContainer.style.display = 'none';
            ui.userInput.focus();
        };

        const startNewChat = () => { 
            // NEW: Revert temp chat UI if active
            document.body.classList.remove('temp-chat-active-border'); // NEW BORDER
            ui.appContainer.classList.remove('temp-chat-active-border'); // NEW BORDER
            ui.disclaimerText.textContent = "Aryanta AI";
            ui.toolsTempChatButton.textContent = "Temporary Chat";
            ui.toolsTempChatButton.classList.remove('temp-chat-active');

            state.isTempChatActive = false; // Exit temp chat mode
            ui.sidebar.style.opacity = '1';
            ui.sidebar.style.pointerEvents = 'auto';

            state.currentChatId = null; ui.chatWindow.innerHTML = ''; ui.chatWatermark.style.opacity = '0.069'; document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active')); 
            setTimeout(() => { const pairId = Date.now(); displayAiMessage("Hello! How can I help you today?", false, pairId); }, 200);
            const questions = (translations[state.uiLanguage] || translations.en).predefined; 
            ui.predefinedQuestionsContainer.innerHTML = '';
            questions.forEach(q => { const button = document.createElement('button'); button.className = 'predefined-q'; button.innerText = q; button.onclick = () => { ui.userInput.value = q; sendMessage(); }; ui.predefinedQuestionsContainer.appendChild(button); }); 
            ui.predefinedQuestionsContainer.style.display = 'flex'; ui.userInput.focus(); 
        };
        
        const createSpeakButton = (textToSpeak) => { const speakBtn = document.createElement('button'); speakBtn.className = 'speak-btn'; speakBtn.title = 'Read Aloud'; speakBtn.setAttribute('aria-label', 'Read message aloud'); speakBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`; speakBtn.onclick = () => { if (speechSynthesis.speaking && state.currentSpeakingButton === speakBtn) { speechSynthesis.cancel(); return; } if (speechSynthesis.speaking) { speechSynthesis.cancel(); } const utterance = new SpeechSynthesisUtterance(textToSpeak); const voices = speechSynthesis.getVoices(); const detectedLang = detectLanguage(textToSpeak); utterance.lang = detectedLang === 'hi' ? 'hi-IN' : 'en-US'; const indianVoice = voices.find(v => v.lang === 'en-IN'); const selectedVoice = voices.find(v => v.voiceURI === state.selectedVoiceURI); if (detectedLang === 'en' && indianVoice) { utterance.voice = indianVoice; } else if (selectedVoice) { utterance.voice = selectedVoice; } utterance.onstart = () => { if (state.currentSpeakingButton) state.currentSpeakingButton.classList.remove('speaking'); speakBtn.classList.add('speaking'); state.currentSpeakingButton = speakBtn; }; utterance.onend = () => { if (state.currentSpeakingButton) state.currentSpeakingButton.classList.remove('speaking'); state.currentSpeakingButton = null; }; utterance.onerror = () => { if (state.currentSpeakingButton) state.currentSpeakingButton.classList.remove('speaking'); state.currentSpeakingButton = null; }; speechSynthesis.speak(utterance); }; return speakBtn; };
        
        const populateVoiceList = () => { const voices = speechSynthesis.getVoices(); ui.voiceSelectionContainer.innerHTML = ''; const desiredVoices = voices.filter(v => v.lang.startsWith('en-') && (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Samantha') || v.name.includes('Daniel') || v.lang === 'en-IN')); const uniqueVoices = [...new Map(desiredVoices.map(item => [item.name, item])).values()].slice(0, 5); if (uniqueVoices.length > 0) { uniqueVoices.forEach(voice => { const option = document.createElement('div'); option.className = 'voice-option'; option.dataset.voiceUri = voice.voiceURI; option.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path></svg><span>${voice.name.replace('Microsoft', '').replace('Google', '').trim()} (${voice.lang})</span>`; option.addEventListener('click', () => { state.tempSelectedVoiceURI = voice.voiceURI; document.querySelectorAll('.voice-option').forEach(el => el.classList.remove('selected')); option.classList.add('selected'); if (speechSynthesis.speaking) speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance("This is the selected voice."); utterance.voice = voice; speechSynthesis.speak(utterance); }); ui.voiceSelectionContainer.appendChild(option); }); } else { ui.voiceSelectionContainer.innerHTML = '<p>No additional voices found.</p>'; } updateVoiceSelectionUI(); };
        const updateVoiceSelectionUI = () => { state.tempSelectedVoiceURI = state.selectedVoiceURI; document.querySelectorAll('.voice-option').forEach(el => el.classList.remove('selected')); if (state.selectedVoiceURI) { const currentOption = document.querySelector(`.voice-option[data-voice-uri="${state.selectedVoiceURI}"]`); if (currentOption) currentOption.classList.add('selected'); } };
        const handleHistoryMenu = (action, id) => { let h = getHistory(); const c = h.find(c => c.id === id); if (!c) return; switch(action) { case 'pin': c.isPinned = !c.isPinned; break; case 'edit': const newTitle = prompt('Enter new title:', c.title); if(newTitle) c.title = newTitle.trim(); break; case 'delete': if(confirm('Delete this chat?')){ h = h.filter(c => c.id !== id); if (id === state.currentChatId) startNewChat(); } break; } saveHistory(h); loadConversationHistory(); };
        const showSettingsView = (viewId) => { ui.settingsViews.forEach(view => view.classList.remove('active')); const targetView = document.getElementById(viewId); if (viewId === 'mainSettings') { ui.settingsBackButton.style.display = 'none'; ui.settingsTitle.innerText = "Settings"; } else { ui.mainSettingsView.classList.remove('active'); ui.settingsBackButton.style.display = 'block'; const buttonText = document.querySelector(`.main-setting-item[data-view='${viewId}'] span`).innerText; ui.settingsTitle.innerText = buttonText; } if (targetView) targetView.classList.add('active'); if (viewId === 'dataSettings') { ui.aryantaIdDisplay.textContent = getOrCreateAryantaId(); } if (viewId === 'memorySettings') { displayMemoriesInSettings(); }};
        const updateSettingsUI = () => { document.querySelectorAll('#answer-style-options .data-option-btn').forEach(btn => { btn.classList.toggle('selected', btn.dataset.style === state.answerStyle); }); document.querySelectorAll('#persona-options .data-option-btn').forEach(btn => { btn.classList.toggle('selected', btn.dataset.persona === state.persona); }); };
        
        // NEW: Memory Management Functions
        const loadMemories = () => {
            const savedMemories = localStorage.getItem('userMemories');
            if (savedMemories) {
                state.userMemories = JSON.parse(savedMemories);
            }
        };
        const displayMemoriesInSettings = () => {
            ui.memoryTextArea.value = state.userMemories.join('\n');
        };
        const saveMemoriesFromSettings = () => {
            // Trim, filter out empty lines, and save
            const memories = ui.memoryTextArea.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            state.userMemories = memories;
            localStorage.setItem('userMemories', JSON.stringify(state.userMemories));
            showToast('Memories saved!'); // NEW: Use toast
            showSettingsView('mainSettings');
        };


        const startListening = () => { if (state.isListening || !recognition) return; try { recognition.start(); } catch (e) { console.error("Recognition start error:", e); state.isListening = false; } };
        const speakLiveAnswer = (text) => { if (speechSynthesis.speaking) speechSynthesis.cancel(); state.isSpeaking = true; ui.liveStatus.textContent = 'Speaking...'; const utterance = new SpeechSynthesisUtterance(text); const voices = speechSynthesis.getVoices(); const detectedLang = detectLanguage(text); utterance.lang = detectedLang === 'hi' ? 'hi-IN' : 'en-US'; const indianVoice = voices.find(v => v.lang === 'en-IN'); const selectedVoice = voices.find(v => v.voiceURI === state.selectedVoiceURI); if (detectedLang === 'en' && indianVoice) utterance.voice = indianVoice; else if (selectedVoice) utterance.voice = selectedVoice; utterance.onend = () => { state.isSpeaking = false; if (state.isLiveModeActive) { startListening(); } else { ui.liveStatus.textContent = 'Click the logo to speak'; } }; utterance.onerror = (e) => { console.error("Speech synthesis error:", e); state.isSpeaking = false; if (state.isLiveModeActive) startListening(); }; speechSynthesis.speak(utterance); };
        const generateAiResponseForLiveMode = async (text) => { const lowerCaseMessage = text.toLowerCase().replace(/[?.,!]/g, ''); const langSetting = localStorage.getItem('appLanguage') || 'auto'; let responseLang = langSetting === 'auto' ? detectLanguage(text) : langSetting; const localKnowledgeBase = (translations[responseLang] || translations.en).localKnowledge; let aiAnswer = localKnowledgeBase[lowerCaseMessage]; if (!aiAnswer) { 
            aiAnswer = await fetchTextAnswer(`Answer this concisely for a voice assistant: "${text}"`, responseLang); 
        } return stripHtml(aiAnswer); };
        const openLiveMode = () => { state.isLiveModeActive = true; ui.liveModeOverlay.style.display = 'flex'; setTimeout(() => ui.liveModeOverlay.style.opacity = '1', 10); ui.appContainer.style.filter = 'blur(5px)'; };
        const closeLiveMode = () => { state.isLiveModeActive = false; if (recognition) recognition.abort(); if (speechSynthesis.speaking) speechSynthesis.cancel(); state.isListening = false; state.isSpeaking = false; ui.liveLogo.classList.remove('listening'); ui.liveStatus.textContent = 'Click the logo to speak'; ui.liveModeOverlay.style.opacity = '0'; ui.appContainer.style.filter = 'none'; setTimeout(() => { ui.liveModeOverlay.style.display = 'none'; }, 400); };
        
        ui.startButton.addEventListener('click', () => { ui.startScreen.style.opacity = '0'; ui.startScreen.style.transform = 'scale(0.9)'; setTimeout(() => { ui.startScreen.style.display = 'none'; ui.appContainer.classList.add('visible'); setTimeout(() => { ui.appContainer.classList.add('active'); startNewChat(); }, 50); }, 500); });
        
        document.addEventListener('DOMContentLoaded', () => { 
            getOrCreateAryantaId();
            const savedLang = localStorage.getItem('appLanguage') || 'auto';
            const radio = document.querySelector(`input[name="language"][value="${savedLang}"]`); if (radio) radio.checked = true;
            applyLanguage(savedLang);
            
            state.isTypingAnimationEnabled = localStorage.getItem('typingAnimation') !== 'false'; 
            ui.typingAnimationToggle.checked = state.isTypingAnimationEnabled; 
            
            state.typingSpeed = parseFloat(localStorage.getItem('typingSpeed') || '1.0');
            ui.typingSpeedSlider.value = state.typingSpeed * 100;
            ui.typingSpeedLabel.textContent = `${ui.typingSpeedSlider.value}%`; 

            // CHANGED: Image Gen default is now false
            state.isImageGenEnabled = localStorage.getItem('imageGenEnabled') === 'true'; // Default to false if not set
            ui.imageGenToggle.checked = state.isImageGenEnabled;

            state.isStudentModeEnabled = localStorage.getItem('studentModeEnabled') === 'true';
            ui.studentModeToggle.checked = state.isStudentModeEnabled;
            
            // NEW: Load Memory & Objective Settings
            state.autoAddMemories = localStorage.getItem('autoAddMemories') === 'true';
            ui.autoAddMemoryToggle.checked = state.autoAddMemories;
            loadMemories(); // Load memories from localStorage into state

            state.selectedVoiceURI = localStorage.getItem('selectedVoiceURI');
            state.answerStyle = localStorage.getItem('answerStyle') || 'default';
            state.persona = localStorage.getItem('persona') || 'default';
            
            updateSettingsUI();
            loadConversationHistory(); 
            if (speechSynthesis.getVoices().length) { populateVoiceList(); } else { speechSynthesis.onvoiceschanged = populateVoiceList; }
            ui.disclaimerText.textContent = 'Aryanta AI is still in development and may sometimes give wrong answers. Please check its responses.';
        });
        
        ui.newChatButton.addEventListener('click', startNewChat);
        
        // NEW: Updated Temp Chat Button Listener
        ui.toolsTempChatButton.addEventListener('click', () => {
            if (state.isTempChatActive) {
                // If it's active, clicking it should close it and start a new, normal chat.
                startNewChat(); 
            } else {
                // If it's not active, start a temp chat.
                startTempChat();
            }
        });

        ui.userInput.addEventListener('input', () => { ui.userInput.style.height = 'auto'; ui.userInput.style.height = (ui.userInput.scrollHeight) + 'px'; });
        ui.sendButton.addEventListener('click', sendMessage);
        ui.stopButton.addEventListener('click', stopTyping);
        ui.userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        document.addEventListener('click', (e) => { 
            if (e.target.closest('.dropdown-item') && e.target.closest('#chatHistory')) { const item = e.target.closest('.dropdown-item'); handleHistoryMenu(item.dataset.action, parseInt(item.dataset.id)); } 
            if (!e.target.matches('.history-menu-btn')) { document.querySelectorAll('.history-dropdown').forEach(d => d.classList.remove('show')); }
            if (!e.target.closest('#tools-button') && !e.target.closest('#tools-dropdown')) {
                ui.toolsDropdown.classList.remove('show');
            }
        });

        ui.toolsButton.addEventListener('click', () => {
            ui.toolsDropdown.classList.toggle('show');
        });

        ui.imageGenToggle.addEventListener('change', (e) => {
            state.isImageGenEnabled = e.target.checked;
            localStorage.setItem('imageGenEnabled', state.isImageGenEnabled);
        });
        ui.studentModeToggle.addEventListener('change', (e) => {
            state.isStudentModeEnabled = e.target.checked;
            localStorage.setItem('studentModeEnabled', state.isStudentModeEnabled);
        });

        // NEW: Auto-memory toggle listener
        ui.autoAddMemoryToggle.addEventListener('change', (e) => {
            state.autoAddMemories = e.target.checked;
            localStorage.setItem('autoAddMemories', state.autoAddMemories);
        });
        
        ui.settingsButton.addEventListener('click', () => { updateVoiceSelectionUI(); showSettingsView('mainSettings'); ui.settingsModal.style.display = 'flex'; });
        
        ui.closeModalButton.addEventListener('click', () => { ui.settingsModal.style.display = 'none'; });

        ui.saveSettingsButton.addEventListener('click', () => {
            const selectedLang = document.querySelector('input[name="language"]:checked').value; localStorage.setItem('appLanguage', selectedLang); applyLanguage(selectedLang);
            state.isTypingAnimationEnabled = ui.typingAnimationToggle.checked; localStorage.setItem('typingAnimation', state.isTypingAnimationEnabled); 
            
            state.typingSpeed = parseFloat(ui.typingSpeedSlider.value) / 100;
            localStorage.setItem('typingSpeed', state.typingSpeed);

            state.selectedVoiceURI = state.tempSelectedVoiceURI; localStorage.setItem('selectedVoiceURI', state.selectedVoiceURI);
            localStorage.setItem('answerStyle', state.answerStyle); localStorage.setItem('persona', state.persona);
            ui.settingsModal.style.display = 'none'; 
        });

        // NEW: Save Memories button listener
        ui.saveMemoriesButton.addEventListener('click', saveMemoriesFromSettings);

        ui.typingSpeedSlider.addEventListener('input', (e) => {
            ui.typingSpeedLabel.textContent = `${e.target.value}%`;
        });

        ui.settingsModal.addEventListener('click', (e) => { if (e.target === ui.settingsModal) { ui.settingsModal.style.display = 'none'; } });

        ui.menuToggleButton.addEventListener('click', () => { ui.sidebar.classList.toggle('show'); ui.sidebarOverlay.classList.toggle('show'); });
        ui.sidebarOverlay.addEventListener('click', () => { ui.sidebar.classList.remove('show'); ui.sidebarOverlay.classList.remove('show'); });
        ui.imageModal.addEventListener('click', (e) => { if (e.target.closest('.close-image-button') || e.target === ui.imageModal) { ui.imageModal.classList.remove('show'); } });
        
        document.querySelectorAll('.main-setting-item').forEach(item => { item.addEventListener('click', () => showSettingsView(item.dataset.view)); });
        ui.settingsBackButton.addEventListener('click', () => showSettingsView('mainSettings'));

        ui.clearAllButton.addEventListener('click', () => { if(confirm('Are you sure you want to delete all chat history? This cannot be undone.')) { localStorage.setItem('chatHistory', '[]'); loadConversationHistory(); startNewChat(); ui.settingsModal.style.display = 'none'; } });
        ui.deleteAllDataButton.addEventListener('click', () => { if(confirm('WARNING: This will delete all chats, memories, and settings, but will keep your unique Aryanta ID. This cannot be undone. Are you sure?')) { const aryantaId = localStorage.getItem('aryantaId'); localStorage.clear(); if (aryantaId) { localStorage.setItem('aryantaId', aryantaId); } location.reload(); } });
        
        document.querySelectorAll('#answer-style-options .data-option-btn').forEach(btn => { btn.addEventListener('click', () => { state.answerStyle = btn.dataset.style; updateSettingsUI(); }); });
        document.querySelectorAll('#persona-options .data-option-btn').forEach(btn => { btn.addEventListener('click', () => { state.persona = btn.dataset.persona; updateSettingsUI(); }); }); 

        ui.imageDownloadButton.addEventListener('click', async () => {
            const downloadUrl = ui.fullscreenImage.src;
            if (!downloadUrl) return;
            
            ui.imageDownloadButton.textContent = "Downloading...";
            try {
                const response = await fetch(downloadUrl);
                const blob = await response.blob();
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `aryanta-ai-image-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
            } catch (error) {
                console.error("Image download failed:", error);
                showToast("Sorry, the image could not be downloaded."); // NEW
            } finally {
                ui.imageDownloadButton.textContent = "Download";
            }
        });

        ui.imageCopyUrlButton.addEventListener('click', () => {
            const url = ui.fullscreenImage.src;
            navigator.clipboard.writeText(url).then(() => {
                showToast("Image URL copied!"); // NEW: Use toast
            }, (err) => {
                console.error('Failed to copy URL: ', err);
                showToast("Failed to copy URL."); // NEW: Use toast
            });
        });

        // NEW: Share Modal Listeners
        ui.shareModalClose.addEventListener('click', () => { ui.shareModal.style.display = 'none'; });
        ui.shareModalXClose.addEventListener('click', () => { ui.shareModal.style.display = 'none'; }); // NEW
        ui.shareModal.addEventListener('click', (e) => { if (e.target === ui.shareModal) { ui.shareModal.style.display = 'none'; } });

        ui.chatWindow.addEventListener('click', async (e) => {
            if (e.target.tagName === 'IMG' && e.target.closest('.message-pair')) {
                const img = e.target;
                const openUrl = img.dataset.openUrl;
                const downloadUrl = img.dataset.downloadUrl;

                ui.fullscreenImage.src = downloadUrl;
                
                if (openUrl) {
                    ui.imageOpenLink.href = openUrl;
                    ui.imageOpenLink.style.display = 'inline-block';
                } else {
                    ui.imageOpenLink.style.display = 'none';
                }
                
                ui.imageDownloadButton.textContent = "Download";
                ui.imageCopyUrlButton.textContent = "Copy URL";
                
                ui.imageModal.classList.add('show'); 
                return; 
            }

            const button = e.target.closest('.action-btn'); if (!button) return;
            const action = button.dataset.action; const messagePairEl = button.closest('.message-pair'); const pairId = parseInt(messagePairEl.dataset.pairId);

            switch (action) {
                case 'copy-user': 
                case 'copy-ai': 
                    const contentEl = button.closest('.message-content').querySelector('.message-text-content'); 
                    navigator.clipboard.writeText(contentEl.innerText); 
                    showToast('Text copied'); // NEW
                    break;
                case 'edit-user': { 
                    // Don't allow editing in temp chat
                    if (state.isTempChatActive) { showToast("Cannot edit messages in a Temporary Chat."); break; } // NEW: Use toast
                    const userMsgContentEl = messagePairEl.querySelector('.user-message .message-text-content'); const oldText = userMsgContentEl.querySelector('div').innerText; const newText = prompt("Edit your message:", oldText); if (newText && newText.trim() && newText.trim() !== oldText.trim()) { const newTextTrimmed = newText.trim(); const history = getHistory(); const chat = history.find(c => c.id === state.currentChatId); if (!chat) return; const messagePair = chat.messages.find(p => p.pairId === pairId); if (!messagePair) return; const tempDiv = document.createElement('div'); tempDiv.innerHTML = messagePair.user.content; tempDiv.querySelector('div').innerText = newTextTrimmed; messagePair.user.content = tempDiv.innerHTML; saveHistory(history); displayUserMessage(messagePair.user.content, pairId); const aiMsgEl = messagePairEl.querySelector('.ai-message'); if (aiMsgEl) aiMsgEl.remove(); await generateAndDisplayResponse(newTextTrimmed, pairId, messagePair.user.content, false); } break; } 
                case 'like-ai': 
                    button.classList.toggle('liked'); 
                    button.parentElement.querySelector('[data-action="dislike-ai"]').classList.remove('disliked'); 
                    showToast('Thanks for your feedback!'); // NEW
                    break;
                case 'dislike-ai': 
                    button.classList.toggle('disliked'); 
                    button.parentElement.querySelector('[data-action="like-ai"]').classList.remove('liked'); 
                    showToast('Thanks for your feedback!'); // NEW
                    break;
                case 'regenerate-ai': {
                    let userPromptText = "";
                    let userPromptHTML = "";

                    if (state.isTempChatActive) {
                        // In temp chat, just get the text from the UI
                        userPromptText = stripHtml(messagePairEl.querySelector('.user-message .message-text-content').innerHTML);
                        userPromptHTML = messagePairEl.querySelector('.user-message .message-text-content').innerHTML;
                    } else {
                        // In normal chat, get from history
                        const history = getHistory();
                        const chat = history.find(c => c.id === state.currentChatId);
                        if (!chat) return;
                        const messagePair = chat.messages.find(p => p.pairId === pairId);
                        if (!messagePair || !messagePair.user) return;
                        userPromptText = stripHtml(messagePair.user.content); 
                        userPromptHTML = messagePair.user.content; 
                    }
                    
                    const aiMsgEl = messagePairEl.querySelector('.ai-message');
                    if (aiMsgEl) aiMsgEl.remove(); 
                    
                    await generateAndDisplayResponse(userPromptText, pairId, userPromptHTML, false); 
                    break; 
                }
                // NEW: Share Action
                case 'share-ai': {
                    const userMsgText = stripHtml(messagePairEl.querySelector('.user-message .message-text-content').innerHTML);
                    const aiMsgText = stripHtml(messagePairEl.querySelector('.ai-message .message-text-content').innerHTML);
                    const lang = state.uiLanguage;
                    
                    // Create preview
                    ui.shareModalContent.innerHTML = `
                        <div class="share-message share-message-user">
                            <b>${(translations[lang] || translations.en).you}:</b>
                            <div>${userMsgText}</div>
                        </div>
                        <div class="share-message share-message-ai">
                            <b>${(translations[lang] || translations.en).ai}:</b>
                            <div>${aiMsgText}</div>
                        </div>
                    `;

                    // Create text for copying and sharing
                    const shareableText = `*User:*\n${userMsgText}\n\n*Aryanta AI:*\n${aiMsgText}\n\n---\nShared from Aryanta AI`;

                    // Set up buttons
                    ui.shareModalCopy.onclick = () => {
                        navigator.clipboard.writeText(shareableText).then(() => {
                            // This button is hidden, but the logic is here if you re-enable it
                            showToast("Copied!"); 
                        });
                    };
                    ui.shareModalWhatsapp.onclick = () => {
                        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(shareableText)}`, '_blank');
                    };

                    ui.shareModal.style.display = 'flex';
                    break;
                }
            }
        });
        
               
        if (SpeechRecognition) {
            ui.liveModeButton.addEventListener('click', openLiveMode);
            ui.closeLiveModeButton.addEventListener('click', closeLiveMode);
            ui.liveLogo.addEventListener('click', () => { if (state.isLiveModeActive) { if (speechSynthesis.speaking) speechSynthesis.cancel(); if (!state.isListening) startListening(); } });
            recognition.onstart = () => { state.isListening = true; ui.liveStatus.textContent = 'Listening...'; ui.liveLogo.classList.add('listening'); };
            recognition.onspeechstart = () => { if (speechSynthesis.speaking) { speechSynthesis.cancel(); } };
            recognition.onend = () => { state.isListening = false; ui.liveLogo.classList.remove('listening'); if (ui.liveStatus.textContent === 'Listening...') { ui.liveStatus.textContent = 'Click the logo to speak'; } };
            recognition.onresult = async (event) => { const transcript = event.results[0][0].transcript; ui.liveStatus.textContent = 'Thinking...'; const aiAnswer = await generateAiResponseForLiveMode(transcript); speakLiveAnswer(aiAnswer); };
            recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); if (event.error !== 'aborted' && event.error !== 'no-speech') { ui.liveStatus.textContent = 'Sorry, I didnt catch that.'; } setTimeout(() => { if (state.isLiveModeActive && !state.isSpeaking) startListening(); }, 1500); };
        }
    </script>
</body>
</html>